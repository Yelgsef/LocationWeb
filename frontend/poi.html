<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POI Cafe | Location Web</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 15% 15%, #1dd3b0 0, #0f3f54 35%, #0c1224 70%, #060915 100%);
      --card: rgba(255, 255, 255, 0.06);
      --text: #e8f5ff;
      --accent: #5eead4;
      --muted: #9fb5c6;
      --outline: rgba(255, 255, 255, 0.12);
      --shadow: 0 24px 52px rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "DM Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    a { color: inherit; text-decoration: none; }
    header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand { font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; }
    nav { display: flex; gap: 12px; }
    nav a {
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--outline);
      transition: all 0.2s ease;
      font-weight: 600;
    }
    nav a:hover { background: rgba(255, 255, 255, 0.12); transform: translateY(-1px); }
    main {
      flex: 1;
      display: grid;
      place-items: center;
      padding: 24px 16px 48px;
    }
    .wrap {
      width: min(960px, 100%);
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
      border: 1px solid var(--outline);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 28px;
      display: grid;
      gap: 20px;
    }
    h1 { margin: 0; font-size: clamp(26px, 3vw, 34px); }
    p.lead { margin: 6px 0 0; color: var(--muted); line-height: 1.6; }
    form {
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    label { font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: #e5f3f6; }
    input, button, select {
      font: inherit;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--outline);
      background: rgba(6, 14, 24, 0.5);
      color: var(--text);
      outline: none;
      width: 100%;
    }
    input[type="range"] { padding: 0; }
    button {
      cursor: pointer;
      background: linear-gradient(120deg, #5eead4, #38bdf8);
      color: #03131f;
      font-weight: 700;
      letter-spacing: 0.2px;
      border: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 28px rgba(14, 165, 233, 0.25);
    }
    button:hover { transform: translateY(-1px); }
    .results {
      background: var(--card);
      border: 1px solid var(--outline);
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 10px;
    }
    .item {
      padding: 12px 12px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid var(--outline);
      display: grid;
      gap: 4px;
    }
    .muted { color: var(--muted); font-size: 14px; }
    .status { font-weight: 700; }
    #map {
      display: none;
      width: 100%;
      height: 360px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--outline);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    @media (min-width: 720px) {
      form { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
      form .full { grid-column: 1 / -1; }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
</head>
<body>
  <header>
    <div class="brand">Location Web</div>
    <nav>
      <a href="/">Home</a>
      <a href="/weather">Weather</a>
      <a href="/translate">Translate</a>
    </nav>
  </header>
  <main>
    <div class="wrap">
      <div>
        <h1>Tìm quán cafe xung quanh</h1>
        <p class="lead">Nhập địa điểm (ví dụ: Hồ Con Rùa, Quận 1) và chọn bán kính để lấy danh sách quán cafe gần đó.</p>
      </div>
      <form id="poi-form">
        <div class="full">
          <label for="query">Địa điểm</label>
          <input id="query" name="query" placeholder="Nhập địa điểm hoặc địa chỉ" required>
        </div>
        <div>
          <label for="radius">Bán kính: <span id="radiusValue">1000</span> m</label>
          <input type="range" id="radius" name="radius" min="100" max="5000" value="1000" step="50">
        </div>
        <div>
          <label for="count">Số quán cafe</label>
          <input type="number" id="count" name="count" min="1" max="50" value="10">
        </div>
        <div class="full">
          <button type="submit">Tìm quán cafe</button>
        </div>
      </form>
      <div class="results">
        <div id="status" class="status">Chưa có kết quả.</div>
        <div id="map"></div>
        <div id="list" class="list"></div>
      </div>
    </div>
  </main>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""></script>
  <script>
    const form = document.getElementById("poi-form");
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const mapEl = document.getElementById("map");
    const radiusInput = document.getElementById("radius");
    const radiusValue = document.getElementById("radiusValue");
    radiusInput.addEventListener("input", () => radiusValue.textContent = radiusInput.value);

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "Đang tìm quán cafe...";
      listEl.innerHTML = "";

      const payload = {
        query: form.query.value.trim(),
        radius: Number(form.radius.value),
        count: Number(form.count.value),
      };
      if (!payload.query) {
        statusEl.textContent = "Vui lòng nhập địa điểm.";
        return;
      }
      try {
        const res = await fetch("/api/poi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Không thể lấy dữ liệu.");
        renderList(data);
      } catch (err) {
        statusEl.textContent = err.message;
      }
    });

    let map;
    let markerLayer;
    let mapFailed = false;

    function ensureMap(lat, lon) {
      if (typeof L === "undefined") {
        mapFailed = true;
        mapEl.style.display = "none";
        return null;
      }
      mapEl.style.display = "block";
      if (!map) {
        map = L.map("map").setView([lat, lon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
        }).addTo(map);
        markerLayer = L.layerGroup().addTo(map);
      }
      return markerLayer;
    }

    function renderList(data) {
      const cafes = data.cafes || [];
      statusEl.textContent = cafes.length
        ? `Tìm thấy ${cafes.length} quán cafe quanh ${data.location.display_name}`
        : "Không tìm thấy quán cafe trong bán kính này.";

      if (!cafes.length) {
        mapEl.style.display = "none";
        listEl.innerHTML = "";
        return;
      }

      const layer = ensureMap(data.location.lat, data.location.lon);
      if (mapFailed) {
        statusEl.textContent = "Không tải được bản đồ (kiểm tra mạng). Danh sách quán vẫn hiển thị.";
      }
      if (layer) {
        map.setView([data.location.lat, data.location.lon], 14);
        layer.clearLayers();
        layer.addLayer(L.circleMarker([data.location.lat, data.location.lon], { radius: 8, color: "#5eead4" }).bindPopup("Điểm trung tâm"));
        cafes.forEach((cafe) => {
          L.marker([cafe.lat, cafe.lon]).addTo(layer).bindPopup(cafe.name);
        });
      }

      const items = cafes.map((cafe, idx) => {
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${cafe.lat},${cafe.lon}`;
        return `
          <div class="item">
            <div><strong>${idx + 1}. ${cafe.name}</strong></div>
            <div class="muted">${cafe.address || "Chưa có địa chỉ"}</div>
            <div class="muted">Lat/Lon: ${cafe.lat.toFixed(5)}, ${cafe.lon.toFixed(5)}</div>
            <a href="${mapsUrl}" target="_blank" rel="noopener">Xem trên bản đồ</a>
          </div>
        `;
      }).join("");
      listEl.innerHTML = items;
    }
  </script>
</body>
</html>
